---
layout: post
title: "指针和数组的误解_读后实验笔记"
date: 2009-02-08  15:30
comments: true
categories: tech
tags: ["c","c++"]
_baiduhi_id: 8ed7f2dc0f1e6ea6cc116674.html
_baiduhi_category: c&c++
---

(hplonline)2009.2.8<br/><br/>
原文：http://richardxx.yo2.cn/articles/%E5%85%B3%E4%BA%8Ec%E6%95%B0%E7%BB%84%E5%92%8C%E6%8C%87%E9%92%88%E7%<br/><br/>
9A%84%E4%B8%80%E7%82%B9%E8%A7%81%E8%A7%A3.html<br/><br/>
这是受启发后的练习笔记：<br/><br/>
实验一：<br/><br/>
a.c:<br/><br/>
int a[] = { 1 , 2 , 3 };<br/><br/>
b.c:<br/><br/>
#include &lt;stdio.h&gt;<br/><br/>
extern int *a;<br/><br/>
int main(){<br/>
      printf("%x\n",&amp;a);<br/>
      printf("%x\n",a);<br/>
      return 0 ;<br/>
}<br/><br/>
输出：<br/>
424a30<br/>
1<br/><br/>
把extern int *a;<br/>
改为extern int a[];<br/><br/>
输出：<br/>
424a30<br/>
424a30<br/><br/>
这个实验说明了数组和指针的语义不同。<br/>
指针：该变量本身占据一个地址，且该地址存储的是一个地址值<br/>
数组：数组名代表就是该数组的首地址值，即上面的a == &amp;a<br/><br/>
------------------------------<br/><br/>
实验二：<br/>
a.c:<br/><br/>
int a[] = { 1 , 2 , 3 };<br/><br/>
b.c:<br/><br/>
#include &lt;stdio.h&gt;<br/><br/>
extern int *a;<br/><br/>
int main(){<br/>
      printf("%x\n",&amp;a);<br/>
      printf("%x\n",(&amp;a)[1]);<br/>
      printf("%x\n",&amp;a[1]);<br/>
//      printf("%x\n",a[1]);<br/>
      return 0 ;<br/>
}<br/><br/>
输出<br/>
424a30<br/>
2<br/>
5<br/><br/>
首先说下最后注释掉的那句，因为语义问题，<br/>
指针a中存的值为1，会把他当作地址来做[1]的运算，<br/>
显然跑到程序领空外面了。<br/><br/>
那么要正确引用a[]的1号元素，就用第二句了。<br/>
先取a的地址，再做[1]的运算。<br/>
&amp;的优先级比[]低，通过二三句对比就知道。<br/><font color="#ff0000">（此段其实是个巧合，因为指针和int都是4字节，详细见1楼-2009.3.13）</font><br/><br/>
那么第三句明明先运行a[1]（优先级），却不像最后一句报错。<br/>
主要是编译器优化的原因。<br/>
a[1] ----&gt; *( a + 1 )<br/>
&amp;a[1] ----&gt; &amp;*( a + 1 )<br/>
连续的取值和取地址消掉了。<br/>
至于5，那是因为a = 1,<br/>
并且按照int型的长度做指针运算，所以 a + 1 ，翻译后其实是 1 + 4<br/><br/>
--------------------<br/><br/>
实验三：<br/>
上到二维，先来个基础的<br/><br/>
a.c:

{% highlight c %}
int a[2][3]={ {1,2,3},{4,5,6} };<br/><br/>
int b[2][3]={ {1,2,3},{4,5,6} };<br/><br/>
{% endhighlight %}

b.c:

#include &lt;stdio.h&gt;<br/><br/>
//如果用 extern int **a ， 则<br/>
//链接出错：unresolved external symbol "int * * a" (?a@@3PAPAHA)<br/>
//少了(*a)的括号也是同样的错误，<br/>
//*a[3]代表的是三个元素的数组，每个元素都是指针<br/>
extern int (*a)[3];<br/>
//很多书把这两种写法等价，或用上面的写法解释二维数组<br/>
//包括编译器和连接器本身，也认同上面的表示<br/>
//否则会unresolved external symbol<br/>
extern int b[][3];<br/><br/>
int main(){<br/>
      printf("%x\n",&amp;a);<br/>
      printf("%x\n",a);<br/>
      printf("%x\n",&amp;a[0][0]);<br/>
      printf("%x\n",&amp;a[0]);<br/>
      printf("%x\n",a[0]);<br/><br/>
      puts("-------");<br/><br/>
      printf("%x\n",&amp;b);<br/>
      printf("%x\n",b);<br/>
      printf("%x\n",&amp;b[0][0]);<br/>
      printf("%x\n",&amp;b[0]);<br/>
      printf("%x\n",b[0]);<br/>
      return 0 ;<br/>
}<br/><br/>
输出：<br/>
424a30<br/>
1<br/>
1<br/>
1<br/>
1<br/>
-------<br/>
424a48<br/>
424a48<br/>
424a48<br/>
424a48<br/>
424a48<br/><br/>
这个还是谈及的语义问题，正如市面上的各类书讲的一样，<br/>
二维数组名==二位数组的地址==第0行数组名==第0行数组地址==第0行0列元素地址<br/>
这里用行序来说<br/>
而对指针，正如上面的a一样，<br/>
根据前面的实验，很奇怪a[0]为啥没有执行出错？<br/>
明明打印出来的值a==1那么解析1[0]显然有问题啊！<br/>
这里是指向数组的指针，情况稍微不同，跟后面一个例子一起说。<br/><br/>
-------------<br/><br/>
实验四：<br/>
把上一个稍改一下，对比下面几组<br/>
      printf("%x\n",a);<br/>
      printf("%x\n",&amp;a[1]);<br/>
      printf("%x\n",a[1]);<br/>
      printf("%x\n",&amp;a[1][1]);<br/>
输出：<br/>
1<br/>
d<br/>
d<br/>
11<br/>
先来第一个，a在这里是指针，a的值就是另外一个文件中定义的第一个元素值 1 <br/>
第二，三个，这样一下就看出端倪了吧，他们的值是一样的<br/>
就是说指向数组的指针和一般的指针是不一样的！<br/>
指向数组的指针在脱指针（[])后，代表的是一个数组，<br/>
用x来记，那么x == &amp;x 对数组是总是成立的。编译器可没搞忘这一点！！<br/>
所以a[1]感觉是解析了一个无效的地址，<br/>
但这个表达式本身是看成一个数组的，关心的是他的地址，<br/>
于是这句话没有问题。<br/>
并且&amp;a[1]也可以得到该地址。<br/><br/>
下面这几句话可以印证普通指针和指向数组指针的区别：<br/>
      int **c = (int **)a;<br/>
      int (*d)[3] = (int (*)[3]) c;<br/>
      //printf("%x\n",c[1]);<br/>
      printf("%x\n",d[1]);<br/>
c为普通指针，注释掉的一句会造成内存错误。<br/>
而下面的一句看出d虽然中间经过了一次转换，依然保持着a的性质。<br/><br/>
另外，关于&amp;a[1]有另外一种理解<br/>
&amp;a[1] = &amp;*( a + 1 ) = a + sizeof( int [3] ) = 1 + 12 = 13<br/>
在这以前，我也会这样理解，<br/>
但这种理解无法解释a[1]的正常执行<br/>
所以现在看来更好的理解是把<br/>
a[1]看作一个数组，根据数组的语义来说&amp;a[1] == a[1]<br/><br/>
---------------<br/><br/>
后面跟几句废话：<br/><br/>
最初学的时候，因为之前学的VB,PASCAL，到整C的时候，<br/>
老是把数组和指针当成两种不同的东西；<br/><br/>
学到一些时候了，自以为看到了数组的本质，<br/>
认为就是一回事了。<br/>
（在我看过的C的书里面，若干本都有这么一句：<br/>
数组的本质就是指针，所以专业的人员更喜欢用指针代替数组来传参。<br/>
我也目睹了大量非专业人员如此行为，包括我）；<br/><br/>
直到现在，才发现数组和指针乃是有很微妙的差异的，<br/>
只是平常没用到这些特性，于是总是得到正确的结果而已。<br/><br/><br/>
宋代禅宗大师青原行思提出参禅的三重境界：参禅之初，看山是山，看水是水；禅有悟时，看山不是山，看水不是水；禅中彻悟，看山仍然山，看水仍然是水。 <br/><br/>
