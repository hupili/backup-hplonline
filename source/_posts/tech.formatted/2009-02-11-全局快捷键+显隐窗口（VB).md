---
layout: post
title: "全局快捷键+显隐窗口（VB)"
date: 2009-02-11  11:47
comments: true
categories: tech
tags: ["Vb"]
_baiduhi_id: 2b6de35041ba1c5b1138c2e6.html
_baiduhi_category: Vb
---

(hplonline)2009.2.11<br/><br/>
既然有同学问到了，就顺便写一个吧。。。<br/><br/>
这个东西网上代码也多。。但是大都懒得解释。。<br/><br/><strong><font color="#0000ff">一。代码</font></strong><br/><br/>
先把代码拿出来再解释，其实很短：<br/><br/><font color="#ff0000">FORM1里面：</font><br/><br/>
Option Explicit<br/><br/>
SetWindowLong Lib "user32" Alias "SetWindowLongA" (ByVal hwnd As Long, ByVal nIndex As Long, ByVal dwNewLong As Long) As Long<br/>
Private Declare Function GetWindowLong Lib "user32" Alias "GetWindowLongA" (ByVal hwnd As Long, ByVal nIndex As Long) As Long<br/>
Private Declare Function RegisterHotKey Lib "user32" (ByVal hwnd As Long, ByVal id As Long, ByVal fskey_Modifiers As Long, ByVal vk As Long) As Long<br/>
Private Declare Function UnregisterHotKey Lib "user32" (ByVal hwnd As Long, ByVal id As Long) As Long<br/><br/>
Const MOD_ALT = &amp;H1<br/>
Const MOD_CONTROL = &amp;H2<br/>
Const MOD_SHIFT = &amp;H4<br/>
Const GWL_WNDPROC = (-4)<br/><br/><br/>
Private Sub Form_Load()<br/>
            key_preWinProc = GetWindowLong(Form1.hwnd, GWL_WNDPROC)<br/>
            SetWindowLong Form1.hwnd, GWL_WNDPROC, AddressOf keyWndproc<br/>
            RegisterHotKey Form1.hwnd, 1, MOD_CONTROL, vbKeyQ<br/>
            RegisterHotKey Form1.hwnd, 2, MOD_CONTROL, vbKeyW<br/>
End Sub<br/><br/><br/>
Private Sub Form_QueryUnload(Cancel As Integer, UnloadMode As Integer)<br/>
        UnregisterHotKey Form1.hwnd, 1<br/>
        UnregisterHotKey Form1.hwnd, 2<br/>
End Sub<br/><font color="#ff0000"><br/>
新建一个模块，放里面：</font><br/>
Option Explicit<br/><br/>
Private Declare Function CallWindowProc Lib "user32" Alias "CallWindowProcA" (ByVal lpPrevWndFunc As Long, ByVal hwnd As Long, ByVal Msg As Long, ByVal wParam As Long, ByVal lParam As Long) As Long<br/><br/>
Const WM_HOTKEY = &amp;H312<br/>
Const MOD_ALT = &amp;H1<br/>
Const MOD_CONTROL = &amp;H2<br/>
Const MOD_SHIFT = &amp;H4<br/>
Const GWL_WNDPROC = (-4)<br/><br/>
Public key_preWinProc As Long<br/><br/>
Public Function keyWndproc(ByVal hwnd As Long, ByVal Msg As Long, ByVal wParam As Long, ByVal lParam As Long) As Long<br/><br/>
        If Msg = WM_HOTKEY Then<br/>
'响应代码<br/>
            If (wParam = 1) Then<br/>
                Form1.Show<br/>
            End If<br/>
            If (wParam = 2) Then<br/>
                Form1.Hide<br/>
            End If<br/>
        End If<br/>
        <br/>
        keyWndproc = CallWindowProc(key_preWinProc, hwnd, Msg, wParam, lParam)<br/>
        <br/>
End Function<br/><br/>
看效果吧，就是Ctrl+Q和Ctrl+w来显示和隐藏FORM1<br/><br/><br/><font color="#0000ff"><strong>二。思路</strong></font><br/><br/>
首先，知道windows有那么一种东西叫消息机制（什么意思？我也不懂，好吧你去百度，了解大意就行）<br/>
然后，处理消息依靠的是窗口过程（什么东西？。。。这个VB封装得太结识了，完全掩盖了这个事情，所以只用过VB的同学觉得很陌生。没关系，知道意思就行，我们马上就要开始写的）<br/>
接着，其实你已经想到了，我们向系统注册快捷键，系统发现按了快捷键，就会通知我们的窗口过程，让我们的窗口过程来处理这个快捷键，我们就在窗口过程中显隐窗口。<br/><br/><font color="#0000ff"><strong>三。声明和常量</strong></font><br/><br/>
先从头说了，两个文件的头部都有一堆<br/>
Private Declare Function 样子的东西，就是要用的API了，<br/>
这么长也不用记的，知道名字就在VB配套的一个API浏览器里面就可以找到了。<br/>
（API是个什么？怎么用API浏览器？这个网上讲得也多）<br/><br/>
然后你要问我从哪里知道这些函数的名字的，<br/>
这个倒是真的不好说。。平时到处逛论坛，看别人的文章，不小心就看到了。。<br/>
如果实在不知道，也可以根据英文来猜，在MSDN里面查。<br/><br/>
不管怎么说，函数的用法还是要在MSDN里面查的，<br/>
如果很熟悉，当然看参数名字就大致知道啥意思了。<br/><br/>
好，再接下来是一堆<br/>
Const 样子的东西，就是用到的一些常量。<br/>
同样可以在API浏览器里面查看到。<br/>
至于常量的名字，你在MSDN里面查看某个函数的时候，往往下面的说明里面会列出来的。<br/><br/><strong><font color="#0000ff">四。注册注销快捷键，改写窗口过程地址</font></strong><br/><br/>
然后说Form_Load()里面的货了，<br/>
下面的很多函数都用到句柄这个东西，就不单说了，网上也多。<br/><br/>
首先GetWindowLong这个函数可以得到一些窗口的参数（可以这么叫吧）<br/>
这里第二个参数传的是GWL_WNDPROC，表示取得窗口过程的地址<br/>
我们把他保存到key_preWinProc里面等着还要用。<br/><br/>
仅接着SetWindowLong，一看这名字，和上面的那个就很对偶，<br/>
我们这就要把自己定义的窗口过程设置进去。<br/>
这样系统发给原窗口过程的消息可以到我们写的窗口过程那里，<br/>
我们就可以判断是不是有快捷键按下了。<br/><br/>
RegisterHotKey直接读出来就是注册快捷键了。<br/>
第二个参数是给快捷键一个编号，于是当你按这个快捷键的时候，这个编号会同时传到你的窗口过程<br/>
第三个参数是模式，可以使用 MOD_ 开头的一系列常量，并且可以通过OR 连接<br/>
第四个参数是虚拟键码，字母键的键码就是对应大写字母的ASCII值<br/>
我RegisterHotKey Form1.hwnd, 1, MOD_CONTROL, vbKeyQ一句<br/>
就是告诉系统，注册一个编号为1的快捷键，按键为Ctrl+Q<br/><br/>
Form_QueryUnload()这个过程里面的两个函数其实类比一下就很明了了<br/>
就是注销掉相应快捷键。不注销会有什么情况呢？你试下不就知道了。。<br/><br/><strong><font color="#0000ff">五。编辑自己的窗口过程</font></strong><br/><br/>
看到了我们的窗口过程<br/>
Public Function keyWndproc(ByVal hwnd As Long, ByVal Msg As Long, ByVal wParam As Long, ByVal lParam As Long) As Long<br/>
为什么长这样呢。。这是规定，没啥好说的。参数就得这么传，返回就得是这样。<br/><br/>
四个参数分别是，接收到消息的窗口的句柄，消息类型，w参数，l参数<br/>
在这里，快捷键消息类型会是WM_HOTKEY<br/>
并且我们注册时，指定的编号会以wParam传进来。<br/><br/>
所以有注释"'响应代码"的地方就是你大师拳脚的位置了。<br/>
你可以在接到这个快捷键之后干任何事情。<br/>
我这里是举例显隐窗口，所以Form1.Hide  , From1.Show就可以了。<br/><br/>
最后  keyWndproc = CallWindowProc(key_preWinProc, hwnd, Msg, wParam, lParam)<br/>
这句话相当关键。<br/>
因为我们自己写的这个窗口过程只对快捷键消息做了响应，<br/>
但是系统会给我们窗口过程发各种各样的消息。<br/>
所以我们要用到那个默认的窗口过程，就是之前改写的时候保存的<br/>
key_preWinProc<br/>
让他来收拾后面的砸碎。<br/>
所以用了CallWindowProc，这个函数，也是个直呼其名便知其意的东西。<br/>
第一个参数是调用的窗口过程的地址，<br/>
后四个参数跟我们一般的窗口过程的参数是一样的，直接传过去就好了。
