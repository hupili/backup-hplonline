---
layout: post
title: "优先级啊优先级（C）"
date: 2009-02-17  16:34
comments: true
categories: tech
tags: ["c","c++"]
_baiduhi_id: a23496827f5325b86c811999.html
_baiduhi_category: c&c++
---

<p>(hplonline)2009.1.31</p>
<p>起因那是非常的朴素，实现一个不用条件等语句返回较大数的函数</p>
<p>int max (int a,int b)</p>
<p> </p>
<p>于是就写了个</p>
<p>int max (int a,int b){<br/>
     return ~( ( a - b ) &gt;&gt; 31 ) &amp; ( a - b ) + b ;<br/>
}</p>
<p> </p>
<p>其实是错的。。。</p>
<p>但是我觉得这想法是对的，然后来了个臃肿的：</p>
<p> </p>
<p>int max (int a,int b){<br/>
     int c = ( a - b ) &gt;&gt; 31 ;<br/>
     c = ~c ;<br/>
     c &amp;= a - b ;<br/>
     c += b ; <br/>
     return c;<br/>
}</p>
<p> </p>
<p>发现这个正常了。。。</p>
<p> </p>
<p>一对比两个的汇编代码。。发现对第一种写法居然编译器“偷工减料”了很多。。。</p>
<p>放到下面，其实不用研究他们。。</p>
<p>1.-----------------<br/>
     return    ( ~( ( a - b ) &gt;&gt; 31 ) ) &amp; ( a - b ) + b ;<br/><br/>
00401578  |.  8B45 08        mov      eax, dword ptr [ebp+8]<br/>
0040157B  |.  2B45 0C        sub      eax, dword ptr [ebp+C]<br/>
0040157E  |.  C1F8 1F        sar      eax, 1F<br/>
00401581  |.  F7D0           not      eax<br/>
00401583  |.  8B4D 08        mov      ecx, dword ptr [ebp+8]<br/>
00401586  |.  23C1           and      eax, ecx<br/><br/><br/>
2.--------------<br/>
     int c = ( a - b ) &gt;&gt; 31 ;<br/>
     c = ~c ;<br/>
     c &amp;= a - b ;<br/>
     c += b ; <br/>
     return    c;<br/><br/>
00401578  |.  8B45 08        mov      eax, dword ptr [ebp+8]<br/>
0040157B  |.  2B45 0C        sub      eax, dword ptr [ebp+C]<br/>
0040157E  |.  C1F8 1F        sar      eax, 1F<br/>
00401581  |.  8945 FC        mov      dword ptr [ebp-4], eax<br/>
00401584  |?  8B4D FC        mov      ecx, dword ptr [ebp-4]<br/>
00401587  |?  F7D1           not      ecx<br/>
00401589  |.  894D FC        mov      dword ptr [ebp-4], ecx<br/>
0040158C  |?  8B55 08        mov      edx, dword ptr [ebp+8]<br/>
0040158F       2B55 0C        sub      edx, dword ptr [ebp+C]<br/>
00401592       8B45 FC        mov      eax, dword ptr [ebp-4]<br/>
00401595       23C2           and      eax, edx<br/>
00401597       8945 FC        mov      dword ptr [ebp-4], eax<br/>
0040159A       8B4D FC        mov      ecx, dword ptr [ebp-4]<br/>
0040159D       034D 0C        add      ecx, dword ptr [ebp+C]<br/>
004015A0 &gt; &gt;  894D FC        mov      dword ptr [ebp-4], ecx<br/>
004015A3    .  8B45 FC        mov      eax, dword ptr [ebp-4]</p>
<p> </p>
<p>看了很久，突然想起。。<font color="#ff0000">貌似算术的优先级比位运算高那么一点</font>。。。汗</p>
<p> </p>
<p>然后这样</p>
<p> </p>
<p>int max (int a,int b){<br/>
     return <span style="color: rgb(255, 0, 0);"><span style="background-color: rgb(136, 136, 136);">(</span> </span> ~( ( a - b ) &gt;&gt; 31 ) &amp; ( a - b ) <span style="color: rgb(255, 0, 0);"><span style="background-color: rgb(136, 136, 136);">)</span> </span> + b ;<br/>
}</p>
<p> </p>
<p>就对了。。。</p>
<p> </p>
<p>其实可以这样</p>
<p> </p>
<p>int max (int a,int b){<br/>
     return <span style="background-color: rgb(136, 136, 136); color: rgb(255, 0, 0);">(</span> ~( a - b &gt;&gt; 31 ) &amp; a - b <span style="background-color: rgb(136, 136, 136); color: rgb(255, 0, 0);">)</span> + b ;<br/>
}</p>
<p> </p>
<p>可见一开始可以不用的地方用了，必须用的地方没有用。。。</p>
<p> </p>
<p>相当悲哀啊。。</p>
<p> </p>
<p>其实编译器挺厉害的，翻译得很简洁</p>
<p> </p>
<p> </p>
<p>00401578  |.  8B45 08        mov      eax, dword ptr [ebp+8]<br/>
0040157B  |.  2B45 0C        sub      eax, dword ptr [ebp+C]</p>
<p><span style="color: rgb(255, 0, 0);">eax = a - b</span> <br/>
0040157E  |.  C1F8 1F        sar      eax, 1F</p>
<p><span style="color: rgb(255, 0, 0);">eax = -1 or 0</span> <br/>
00401581  |.  F7D0           not      eax</p>
<p><span style="color: rgb(255, 0, 0);">eax = 0 or -1</span> <br/>
00401583  |.  8B4D 08        mov      ecx, dword ptr [ebp+8]<br/>
00401586  |.  2B4D 0C        sub      ecx, dword ptr [ebp+C]</p>
<p><span style="color: rgb(255, 0, 0);">ecx = a - b</span> <br/>
00401589  |.  23C1           and      eax, ecx</p>
<p><span style="color: rgb(255, 0, 0);">eax = 0 or ecx</span> <br/>
0040158B  |.  0345 0C        add      eax, dword ptr [ebp+C]</p>
<p><span style="color: rgb(255, 0, 0);">eax = b or a</span></p>
<p> </p>
<p>然后这个EAX正好带值返回了。。。</p>
