---
layout: post
title: "不用条件,返回大数，且效率更高"
date: 2009-03-06  21:30
comments: true
categories: tech
tags: ["c","c++"]
_baiduhi_id: 8504fa1f4fa13dfde1fe0b1e.html
_baiduhi_category: c&c++
---

<pre class="prettyprint"><span class="kwd">(hplonline)2009.3.6<br/><br/>都是老话题了,不过这次讨论一点其他方面的东西,即效率更高<br/><br/><font color="#0000ff">一。代码如下:</font><br/><br/><font color="#ff6600">int</font></span><font color="#ff6600"><span class="pln"> max </span><span class="pun">(</span><span class="kwd">int</span><span class="pln"> a</span><span class="pun">,</span><span class="kwd">int</span><span class="pln"> b</span><span class="pun">){</span><span class="pln"><br/></span><span class="kwd">return</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">~(</span><span class="pln"> a </span><span class="pun">-</span><span class="pln"> b </span><span class="pun">&gt;&gt;</span><span class="pln"> </span><span class="lit">31</span><span class="pln"> </span><span class="pun">)</span><span class="pln"> </span><span class="pun">&amp;</span><span class="pln"> a </span><span class="pun">-</span><span class="pln"> b </span><span class="pun">)</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> b </span><span class="pun">;</span><span class="pln"><br/></span><span class="pun">}</span></font><span class="pln"><br/><br/><font color="#0000ff">二。原理就很简单了.</font><br/>a-b可以得到一个符号<br/>右移31位，这里是带符号右移，所以结果是<br/>a&gt;b:0;a&lt;b:-1<br/>取反：<br/>a&gt;b:-1;a&lt;b:0<br/>再和a-b与上<br/>a&gt;b:a-b;a&lt;b:0<br/>最后加个b<br/>a&gt;b:a;a&lt;b:b<br/><br/><font color="#ff6600">这里有点问题:就是溢出。</font><br/>比方说,a为负，b为正，两个数的绝对值都超大<br/>减出来可能变成个正数了！<br/><br/>不过，除了极端数据外，应用前景还是有那么点点<br/><br/><font color="#0000ff">三。然后我们来看效率：</font><br/><br/>下面直接引freebsd(jingmi)兄的了：<br/><br/></span><font color="#ff00ff">囧rz，今天不宜灌水，刚刚在另外一个地方讨论也犯了个大错……<br/><br/>实测了一下，这么玩的确是要快点，看数据吧：<br/><br/><span class="kwd">int</span><br/></font></pre>
<font color="#ff00ff"><span class="pln">main</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span><span class="pln"><br/></span><span class="pun">{</span><span class="pln"><br/></span><span class="kwd">int</span><span class="pln"> a </span><span class="pun">=</span><span class="pln"> </span><span class="lit">3</span><span class="pun">;</span><span class="pln"><br/></span><span class="kwd">int</span><span class="pln"> b </span><span class="pun">=</span><span class="pln"> </span><span class="lit">2</span><span class="pun">;</span><span class="pln"><br/></span><span class="kwd">int</span><span class="pln"> ret</span><span class="pun">;</span><span class="pln"><br/><br/></span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">int</span><span class="pln"> i</span><span class="pun">=</span><span class="lit">0</span><span class="pun">;</span><span class="pln"> i</span><span class="pun">&lt;</span><span class="lit">1000000000</span><span class="pun">;</span><span class="pln"> i</span><span class="pun">++)</span><span class="pln"><br/></span><span class="pun">{</span><span class="pln"><br/></span><span class="com">#ifdef FUN</span><span class="pln"><br/>
ret </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">~(</span><span class="pln"> a </span><span class="pun">-</span><span class="pln"> b </span><span class="pun">&gt;&gt;</span><span class="pln"> </span><span class="lit">31</span><span class="pln"> </span><span class="pun">)</span><span class="pln"> </span><span class="pun">&amp;</span><span class="pln"> a </span><span class="pun">-</span><span class="pln"> b </span><span class="pun">)</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> b</span><span class="pun">;</span><span class="pln"><br/></span><span class="com">#else</span><span class="pln"><br/>
ret </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="pln">a</span><span class="pun">&gt;</span><span class="pln">b</span><span class="pun">)?</span><span class="pln">a </span><span class="pun">:</span><span class="pln"> b</span><span class="pun">;</span><span class="pln"><br/></span><span class="com">#endif</span><span class="pln"><br/></span><span class="pun">}</span><span class="pln"><br/><br/></span><span class="kwd">return</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span><span class="pln"><br/></span><span class="pun">}</span><span class="pln"><br/></span><br/><br/>
这里把函数直接放进去了，避免函数调用开销。<br/><br/>
没有 define FUN 的情况下：<br/>
cc -Wall -Wextra -std=c99 test.c -o comp<br/>
jingmi@主机名打码~$time ./comp<br/>
4.311u 0.000s 0:04.31 100.0%    0+0k 0+0io 0pf+0w<br/><br/>
define FUN 的情况下：<br/>
cc -Wall -Wextra -std=c99 -DFUN test.c -o sarl<br/>
jingmi@主机名打码~$time ./sarl<br/>
3.021u 0.000s 0:03.02 100.0%    0+0k 0+0io 0pf+0w<br/><br/>
故意没有开优化，10亿次运算差了1.3秒，还是比较明显。<br/><br/>
但使用 pl 的算法需要注意的就是要 inline，而这个可能和编译器的优化有很大关系，另外生成的代码也比较复杂。<br/><br/>
另外在 c 中，这样写运算符优先级可能有点小问题。</font>
<pre class="prettyprint">为什么呢？下面直接引我粗糙的分析了：<br/><br/>几年前的一篇论文里面，<br/><br/>作者在他机器上测得的跳转类指令大概平均耗<font color="#ff0000">40个周期</font><br/><br/>而数据移动，移位，位运算类指令平均<font color="#ff0000">1个周期。</font><br/><br/>如果在这样的一台机器上。<br/><br/>那么用8条如下指令代替条件跳转是有效果的。。</pre>
<font color="#ff00ff"><span class="lit">00401578</span><span class="pln">  </span><span class="pun">|.</span><span class="pln">  </span><span class="lit">8B45</span><span class="pln"> </span><span class="lit">08</span><span class="pln">       mov     eax</span><span class="pun">,</span><span class="pln"> dword ptr </span><span class="pun">[</span><span class="pln">ebp</span><span class="pun">+</span><span class="lit">8</span><span class="pun">]</span><span class="pln"><br/></span><span class="lit">0040157B</span><span class="pln">  </span><span class="pun">|.</span><span class="pln">  </span><span class="lit">2B45</span><span class="pln"> </span><span class="lit">0C</span><span class="pln">       </span><span class="kwd">sub</span><span class="pln">     eax</span><span class="pun">,</span><span class="pln"> dword ptr </span><span class="pun">[</span><span class="pln">ebp</span><span class="pun">+</span><span class="pln">C</span><span class="pun">]</span><span class="pln"><br/>
eax </span><span class="pun">=</span><span class="pln"> a </span><span class="pun">-</span><span class="pln"> b<br/></span><span class="lit">0040157E</span><span class="pln">  </span><span class="pun">|.</span><span class="pln">  C1F8 </span><span class="lit">1F</span><span class="pln">       sar     eax</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1F</span><span class="pln"><br/>
eax </span><span class="pun">=</span><span class="pln"> </span><span class="pun">-</span><span class="lit">1</span><span class="pln"> </span><span class="kwd">or</span><span class="pln"> </span><span class="lit">0</span><span class="pln"><br/></span><span class="lit">00401581</span><span class="pln">  </span><span class="pun">|.</span><span class="pln">  F7D0          </span><span class="kwd">not</span><span class="pln">     eax<br/>
eax </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pln"> </span><span class="kwd">or</span><span class="pln"> </span><span class="pun">-</span><span class="lit">1</span><span class="pln"><br/></span><span class="lit">00401583</span><span class="pln">  </span><span class="pun">|.</span><span class="pln">  </span><span class="lit">8B4D</span><span class="pln"> </span><span class="lit">08</span><span class="pln">       mov     ecx</span><span class="pun">,</span><span class="pln"> dword ptr </span><span class="pun">[</span><span class="pln">ebp</span><span class="pun">+</span><span class="lit">8</span><span class="pun">]</span><span class="pln"><br/></span><span class="lit">00401586</span><span class="pln">  </span><span class="pun">|.</span><span class="pln">  </span><span class="lit">2B4D</span><span class="pln"> </span><span class="lit">0C</span><span class="pln">       </span><span class="kwd">sub</span><span class="pln">     ecx</span><span class="pun">,</span><span class="pln"> dword ptr </span><span class="pun">[</span><span class="pln">ebp</span><span class="pun">+</span><span class="pln">C</span><span class="pun">]</span><span class="pln"><br/>
ecx </span><span class="pun">=</span><span class="pln"> a </span><span class="pun">-</span><span class="pln"> b<br/></span><span class="lit">00401589</span><span class="pln">  </span><span class="pun">|.</span><span class="pln">  </span><span class="lit">23C1</span><span class="pln">          </span><span class="kwd">and</span><span class="pln">     eax</span><span class="pun">,</span><span class="pln"> ecx<br/>
eax </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pln"> </span><span class="kwd">or</span><span class="pln"> ecx<br/></span><span class="lit">0040158B</span><span class="pln">  </span><span class="pun">|.</span><span class="pln">  </span><span class="lit">0345</span><span class="pln"> </span><span class="lit">0C</span><span class="pln">       add     eax</span><span class="pun">,</span><span class="pln"> dword ptr </span><span class="pun">[</span><span class="pln">ebp</span><span class="pun">+</span><span class="pln">C</span><span class="pun">]</span><span class="pln"><br/>
eax </span><span class="pun">=</span><span class="pln"> b </span><span class="kwd">or</span></font><span class="pln"><font color="#ff00ff"> a</font><br/></span><br/><br/>
不过都说了哈，是几年前的数据。我自己机器上没有实测。<img src="http://bbs.stuhome.net/images/post/smile/yang/16.gif"/><br/><br/>
啥时候有空测一下。。<img src="http://bbs.stuhome.net/images/post/smile/yang/18.gif"/><br/><br/>
现在的硬件都优化得很好了，像乘法都平均到2周期了。。
<pre class="prettyprint"><br/><br/>好了我ctrl+c,ctrl+v完了。</pre>
