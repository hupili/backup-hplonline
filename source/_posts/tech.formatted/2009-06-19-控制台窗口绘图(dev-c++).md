---
layout: post
title: "控制台窗口绘图(dev-c++)"
date: 2009-06-19  17:33
comments: true
categories: tech
tags: ["c","c++"]
_baiduhi_id: e9f38c18ddd9cbbd4bedbcf3.html
_baiduhi_category: c&c++
---

(hplonline)2009.6.19<br/><br/>
C有一套图形接口函数在graphics.h里面定义。<br/>
而C++的编译器一般都没有带上这套库了。<br/><br/>
不管怎么说，控制台窗口虽然长得黑不溜秋的，<br/>
本质上也是个窗口，那么就可以用win32的GDI来完成。<br/><br/>
下面就画这样一个矩形出来。<br/><br/><div forimg="1"><img border="0" src="http://hiphotos.baidu.com/hplonline/pic/item/89c8780e083ffcec7acbe1b8.jpg" small="0" class="blogimg"/></div>
<br/><font color="#0000ff">原理：</font><br/><br/>
和一般的GDI绘图步骤一样。<br/>
得到窗口句柄，创建DC，绘图，释放DC<br/><br/><font color="#0000ff">程序：</font><br/><br/>
看到下面注释掉的东西，就知道经过了不少梗塞的尝试。<br/>
先把代码拿出来，然后说说实现上的问题。<br/><br/>
#include &lt;iostream&gt;<br/>
#include &lt;windows.h&gt;<br/>
using namespace std ; <br/><font color="#339966">//#pragma comment(lib , "gdi32.lib")</font><br/><br/>
typedef BOOL (*func_rectangle)(<br/>
  HDC hdc,          // handle to device context<br/>
  int nLeftRect,    // x-coord of bounding rectangle's upper-left corner<br/>
  int nTopRect,     // y-coord of bounding rectangle's upper-left corner<br/>
  int nRightRect,  // x-coord of bounding rectangle's lower-right corner<br/>
  int nBottomRect  // y-coord of bounding rectangle's lower-right corner<br/>
)<font color="#ff0000">__attribute__((stdcall));</font><br/><br/>
int main(){<br/>
     SetConsoleTitle("hplonline") ;<br/>
     HWND hWnd = FindWindow(NULL , "hplonline") ;<br/>
     HDC hDC = GetDC(hWnd) ;<br/>
     HMODULE hLib = LoadLibrary("gdi32.dll") ;<br/><font color="#339966">     //printf("%x\n",hLib);</font><br/>
     func_rectangle pRectangle = (func_rectangle)GetProcAddress(hLib , "Rectangle") ;<br/><font color="#339966">     //printf("%x\n",pRectangle);</font><br/>
     (*pRectangle)(hDC , 100 , 100 , 200 , 200 ) ;<br/><font color="#339966">     //Rectangle(hDC , 100 , 100 , 200 , 200 ) ;</font><br/>
     getchar();<br/>
     ReleaseDC(hWnd , hDC) ;  <br/><font color="#339966">     //system("pause") ;</font><br/>
     return 0 ;     <br/>
}<br/><br/><font color="#0000ff">1。得到窗口句柄<br/><br/></font>GetStdHandle函数得到的是控制台的<font color="#ff0000">输入输出句柄</font>，<br/>
这里要绘图，应该先得到<font color="#ff0000">窗口句柄</font>。<br/><br/>
由于没有直接的函数来完成这个事情。<br/>
M$给了一套用FindWindow的<a href="http://support.microsoft.com/kb/124103/zh-cn" target="_blank">解决方案</a>。<br/>
讲解很详细，而且考虑很周全，<br/>
比如先把窗口标题改为唯一的，再查找窗口，然后又改回来。<br/><br/><font color="#0000ff">2。取得相关的函数</font><br/><br/>
根据我的注释就看得出来，其实本来想直接写<br/>
Rectangle函数调用的。<br/><br/>
结果出来个错误：<br/><font color="#ff0000">  [Linker error] undefined reference to `Rectangle@20' </font><br/><br/>
连接器没有找到Rectangle的实现。<br/>
从函数的名字来看，知道要传入20字节的参数，是__stdcall约定的。<br/><br/>
在VC6下，IDE默认给连接器设置了如下库的：<br/>
kernel32.lib user32.lib winspool.lib comdlg32.lib advapi32.lib <font color="#ff0000">gdi32.lib</font><br/>
shell32.lib ole32.lib oleaut32.lib uuid.lib odbc32.lib odbccp32.lib <br/>
可以在project-&gt;settings-&gt;link  .. Object/Library modules 看到他们。<br/><br/>
当然，我所想到的第二点就是用#pragma comment把库添加进去，<br/><font color="#339966">#pragma comment(lib , "gdi32.lib")</font><br/>
在VC下经常这样搞，但是这回还是报错依然。<br/><br/>
于是去VC下面试了一下，手动把gdi32.lib从链接选项中去掉。<br/>
错误出来了：<br/><font color="#ff0000">error LNK2001: unresolved external symbol __imp__Rectangle@20</font><br/>
多个__imp__前缀，表示导入函数。<br/>
加上<font color="#339966">pragma comment(lib , "gdi32.lib")<br/></font>结果可以用了。<br/><br/>
看来在DEV下要找点其他的方法。<br/>
这里仅仅缺GDI32.DLL的函数，<br/>
但像 LoadLIbrary,GetProcAddress之类的都是有的。<br/>
于是就用他们两来取得任何想要的函数了。<br/><br/><font color="#0000ff">3。函数指针，调用约定</font><br/><br/>
用GetProcAddress得到的仅仅是一个地址，<br/>
要自己指定函数指针的类型。<br/><br/>
typedef BOOL (*func_rectangle)(<br/>
  HDC hdc,          // handle to device context<br/>
  int nLeftRect,    // x-coord of bounding rectangle's upper-left corner<br/>
  int nTopRect,     // y-coord of bounding rectangle's upper-left corner<br/>
  int nRightRect,  // x-coord of bounding rectangle's lower-right corner<br/>
  int nBottomRect  // y-coord of bounding rectangle's lower-right corner<br/>
)<font color="#ff0000">__attribute__((stdcall));</font><br/><br/>
上午在VC6中试的时候，由于对结合规则不清楚搞了很久。<a href="http://hi.baidu.com/hplonline/blog/item/e936db001972dd18738b65a2.html" target="_blank">参考这个</a>。<br/>
用DEV的话，就像下面标红的地方一样，比较容易写。<br/><br/>
