---
layout: post
title: "控制台的底层输入函数获取鼠标信息"
date: 2009-08-26  21:25
comments: true
categories: tech
tags: ["Vc"]
_baiduhi_id: ea07a1640f40a0f9f6365466.html
_baiduhi_category: Vc
---

<p>(hplonline)2009.8.26</p>
<p>看到了一个底层的控制台输入函数。<br/>
ReadConsoleInput</p>
<p>非常强大，于是在控制台下也可以玩鼠标了。</p>
<p>读入的INPUT_RECORD定义如下：</p>
<p>typedef struct _INPUT_RECORD { // ir <br/>
     WORD EventType; <br/>
     union { <br/>
         KEY_EVENT_RECORD KeyEvent; <br/>
         MOUSE_EVENT_RECORD MouseEvent; <br/>
         WINDOW_BUFFER_SIZE_RECORD WindowBufferSizeEvent; <br/>
         MENU_EVENT_RECORD MenuEvent; <br/>
         FOCUS_EVENT_RECORD FocusEvent; <br/>
     } Event; <br/>
} INPUT_RECORD;</p>
<p>EventType可以判断出事件类型。<br/>
下面Event是个联合，<br/>
不同的EventType时，应该用不同的结构体去对应其中的信息。</p>
<p>跟鼠标有关的是这个：<br/>
typedef struct _MOUSE_EVENT_RECORD { // mer <br/>
     COORD dwMousePosition; <br/>
     DWORD dwButtonState; <br/>
     DWORD dwControlKeyState; <br/>
     DWORD dwEventFlags; <br/>
} MOUSE_EVENT_RECORD;</p>
<p>其中要取得坐标和按键状态都很容易了，在MSDN上很清楚。<br/>
要注意的是，x坐标是向右，y坐标是向下。<br/>
并且控制台的尺寸是80*25。<br/>
但当输出内容过多的时候，会向下滚动，<br/>
于是得到的(x,y)坐标的行值可能会一直增大。<br/>
最大的时候也就是299，因为只支持300行。</p>
<p><font color="#0000ff">一个演示程序：</font></p>
<p>输出鼠标的位置，并且用'0'画上一个跟随鼠标走的十字标记。</p>
<p><br/>
#include &lt;stdio.h&gt;<br/>
#include &lt;windows.h&gt;</p>
<p>const int ROW = 25 ;<br/>
const int COL = 80 ;</p>
<p>char buffer[ROW][COL] ;</p>
<p>HANDLE ih ;<br/>
HANDLE oh ;</p>
<p>void back_to_00(){<br/>
     COORD cp ;<br/>
     int ret ;<br/>
     cp.X = 0 ; <br/>
     cp.Y = 0 ;<br/>
     ret = SetConsoleCursorPosition(oh , cp) ;<br/>
}</p>
<p>void draw_heart(int x , int y){<br/>
     int i , j ;<br/>
     for ( i = 0 ; i &lt; ROW ; i ++ ){<br/>
         buffer[i][x] = '0' ;<br/>
     }<br/>
     for ( j = 0 ; j &lt; COL ; j += 2 ){<br/>
         buffer[y][j] = '0' ;<br/>
     }<br/>
     sprintf(buffer[0] , "(%d,%d)" , x , y) ;<br/>
}</p>
<p>void flush_buffer(){<br/>
     int i , j ;<br/>
     back_to_00() ;<br/>
     for ( i = 0 ; i &lt; ROW ; i ++ ){<br/>
         for ( j = 0 ; j &lt; COL ; j ++ ){<br/>
             putchar(buffer[i][j]) ;<br/>
         }<br/>
     }<br/>
     back_to_00() ;<br/>
     memset(buffer , ' ' , sizeof(buffer)) ;<br/>
}</p>
<p>int main(){<br/>
     INPUT_RECORD irc ;<br/>
     DWORD n ;<br/>
     ih = GetStdHandle(STD_INPUT_HANDLE) ;<br/>
     oh = GetStdHandle(STD_OUTPUT_HANDLE) ;<br/>
     flush_buffer() ;<br/>
     while(1){<br/>
         ReadConsoleInput(ih , &amp;irc , 1 , &amp;n) ;<br/>
         if ( n == 1 ){<br/>
             if ( irc.EventType == MOUSE_EVENT ) {<br/>
                 MOUSE_EVENT_RECORD mrc = irc.Event.MouseEvent ;<br/>
                 //flush_buffer() ;<br/>
                 //printf("%d,%d\n" , mrc.dwMousePosition.X , mrc.dwMousePosition.Y ) ;<br/>
                 //puts("mouse") ;<br/>
                 draw_heart(mrc.dwMousePosition.X , mrc.dwMousePosition.Y) ;<br/>
                 flush_buffer() ;<br/>
             }<br/>
         }<br/>
     }<br/>
     return 0 ;<br/>
}</p>
<p> </p>
<p><font color="#0000ff">效果：</font></p>
<p><span><img class="blogimg" border="0" small="0" src="http://hiphotos.baidu.com/hplonline/pic/item/c762de3f69bd75e87c1e715a.jpg"/><br/></span></p>
<p> </p>
