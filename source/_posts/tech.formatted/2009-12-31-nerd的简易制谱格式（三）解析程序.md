---
layout: post
title: "nerd的简易制谱格式（三）解析程序"
date: 2009-12-31  14:46
comments: true
categories: tech
tags: ["Matlab"]
_baiduhi_id: ea07a164b3474cfbf7365499.html
_baiduhi_category: Matlab
---

<p>(hplonline)2009.12.31</p>
<p>即前面下载包中的composer.m。</p>
<p>根据文件格式描述，做这样一个程序相当于一个模拟题。</p>
<p>出于简化，并不对音乐文件进行验证，假设是完全正确的。</p>
<p>从mymusic.m生成result.wav，并且播放。</p>
<p>function main</p>
<p>clear ;<br/>
clc ;<br/>
close all ;</p>
<p>% L1 131 L2 147 L3 165 L4 175 L5 196 L6 220 L7 247 <br/>
% N1 262 N2 296 N3 330 N4 349 N5 392 N6 440 N7 494 <br/>
% H1 523 H2 587 H3 659 H4 698 H5 784 H6 880 H7 988 <br/>
% I1 1047 I2 1175 I3 1319 I4 1397 I5 1568 I6 1760 I7 1976</p>
<p>fid = fopen('mymusic.m') ;</p>
<p>fs = 44100 ; %采样率<br/>
T=0.5 ; %默认元音符长度<br/>
U=1 ; %默认单位音符长度<br/>
S=2 ; %默认当前音阶</p>
<p>w = [] ; %声音序列</p>
<p>while 1<br/>
     s = fscanf(fid , '%s' , [1 , 1]) ;<br/>
     if ~isempty(s)<br/>
         disp(s) ;<br/>
         <br/>
         switch s(1)<br/>
             case '%'<br/>
                 fgets(fid) ;%comment is behind the token '%'<br/>
                 continue ; <br/>
             case 'T'<br/>
                 T = sscanf(s(3:end) , '%f' , [1 , 1]) ;<br/>
                 continue ;<br/>
             case 'S'<br/>
                 S = get_index(s(3)) ;<br/>
                 continue ;<br/>
             case 'U'<br/>
                 U = sscanf(s(3:end) , '%f' , [1 , 1]) ;<br/>
                 continue ;<br/>
         end<br/>
         <br/>
         step = get_index(s(1)) ;<br/>
         if isempty(step)<br/>
             step = S ;<br/>
         else <br/>
             s = s(2:end) ;<br/>
         end<br/>
         <br/>
         if s(1) == 'D' <br/>
             flag = 1 ;<br/>
             s = s(2:end) ;<br/>
         else <br/>
             flag = 0 ;<br/>
         end<br/>
         <br/>
         if sum(s == ',')<br/>
             [rev , ren] = sscanf(s , '%f,%f' , [1 , 2]) ;<br/>
             note = rev(1) ;<br/>
             times = rev(2) ;<br/>
         else <br/>
             note = sscanf(s , '%f' , [1 , 1]) ;<br/>
             times = 1 ;<br/>
         end<br/>
         <br/>
         length = T * U * times ;<br/>
         if flag<br/>
             freq = note ;<br/>
         else<br/>
             freq = get_freq(step , note) ;<br/>
         end<br/>
         <br/>
         re = get_series(freq ,length , fs) ;<br/>
         <br/>
         w = [w , re] ;<br/>
     else <br/>
         break ;<br/>
     end<br/>
end<br/>
fclose(fid)</p>
<p>wavplay(w , fs) ;<br/>
wavwrite(w , fs , 8 , 'result.wav') ;</p>
<p>return ;</p>
<p>function freq = get_freq(step , note)<br/>
     f = [<br/>
         131 147 165 175 196 220 247 <br/>
         262 296 330 349 392 440 494 <br/>
         523 587 659 698 784 880 988 <br/>
         1047 1175 1319 1397 1568 1760 1976 <br/>
     ] ;<br/>
     if note == 0 <br/>
         freq = 0 ;<br/>
     else <br/>
         if isempty(step) || (note &lt; 1) || (note &gt; 7)<br/>
             freq = 0 ;<br/>
         else<br/>
             freq = f(step , note) ;<br/>
         end<br/>
     end<br/>
return ;</p>
<p>function index = get_index(c)<br/>
     a = 'LNHI' ;<br/>
     index = find(a == c) ;<br/>
return ;</p>
<p>function re = get_series(frequency , length , fs)<br/>
     vac_len = 0.05 ;<br/>
     N = fix(length / (1 / fs)) ;<br/>
     t = (0:N-1) / fs ;<br/>
     re = sin(2 * pi * frequency * t) ;<br/>
     re((N - fix(N * vac_len) + 1):N) = 0 ;<br/>
return ;</p>
