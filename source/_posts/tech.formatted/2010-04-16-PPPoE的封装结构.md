---
layout: post
title: "PPPoE的封装结构"
date: 2010-04-16  22:55
comments: true
categories: tech
tags: ["Network"]
_baiduhi_id: 0832b63e8f9c6cf6838b13fb.html
_baiduhi_category: Network
---

(hplonline)2010.4.16<br/><br/><font color="#0000ff">起因：</font><br/><br/>
昨天跟几个研究生调接入网实验室的设备，<br/>
完了后抓了下PPPoE的包，<br/>
发现封装很奇特，类似如下：<br/><br/><span><img border="0" class="blogimg" small="0" src="http://hiphotos.baidu.com/hplonline/pic/item/1dd98d44a409f17b530ffe77.jpg"/></span><br/><br/>
172.16.1.118和172.16.1.116是两台机器PPPoE拨号后服务器分给的地址。<br/><br/>
从理论上来讲，ping一下，抓到的帧的封装应该是这样的：<br/>
icmp<br/>
ip<br/>
ppp<br/>
pppoe<br/>
mac<br/><br/>
感觉这个事情和原理不符合。<br/><br/>
又因为之前无意抓过一次，看到了ppp的层。<br/>
那次得到的两个地址是不同子网的，<br/>
于是得到了一个结论，<br/><font color="#ff0000">说在同一子网的数据包不经过ppp封装。（错）</font><br/><br/><font color="#0000ff">原理探讨：</font><br/><br/>
ppp拨号前应该有一个地址IP，<br/>
拨号有一个地址IP(PPP)。<br/><br/>
如果是使用前者通信，<br/>
则应该是IP之后直接走到MAC层。<br/>
同一内网用户就是这样干的，<br/>
所以PPPoE对内网用户缺乏有力的控制。<br/><br/>
如果是使用后者通信，<br/>
那么不管两台机器的物理位置如何，<br/>
都得和服务器建立虚连接，<br/>
从服务器那里绕一圈回来通信。<br/><br/>
在上面的例子中，<br/>
用的是PPPoE服务器给的两个地址来ping。<br/>
所以应该是具有PPP封装的才对。<br/><br/>
上午和老师讨论过，<br/>
认为现象上确实存在问题，<br/>
于是下午重新抓了下包。<br/><font color="#0000ff"><br/>
抓包的操作问题：</font><br/><br/>
这里非常感谢cong哥犀利的眼光，<br/>
一来就发现了是选择网卡的问题。<br/>
原来选择物理网卡可以抓出这样的包：<br/><br/><span><img border="0" class="blogimg" small="0" src="http://hiphotos.baidu.com/hplonline/pic/item/9361ac1e1e2416284334177d.jpg"/></span><br/><br/>
注意Wireshark这个是低层次放在上面。<br/>
这样出来的结果就是和理论完全符合的了。<br/><br/>
--<br/><font color="#ff0000"><br/>
所以可见昨天的现象纯属巧合了。<br/>
当抓不同子网的时候，恰好选到了物理网卡。<br/>
当抓同一子网的时候，选到了ppp的虚拟网卡。</font><br/>
这就出现了前面那个别扭的错误结论。<br/><br/><font color="#0000ff">深层次的问题：</font><br/><br/>
在拨号之后，会出现一个ppp的虚拟网卡。<br/>
这应该算是系统实现上的巧妙之处吧。<br/><br/>
默认路由指向ppp网卡出去的网关，<br/>
那么当用户在内网交互的时候，<br/>
可以直接走MAC，<br/>
除此之外，都从ppp这边交出去。<br/><br/><font color="#ff0000">而实际实现中，并不是像我们想象的，<br/>
各个实体从上倒下依次堆叠。</font><br/>
依次堆叠出来的效果将是，<br/>
IP实体需要知道某个包应该由哪个下层去交付，<br/>
才能够决定给MAC还是ppp。<br/>
这样会涉及到改变IP实体的实现，不是很科学。<br/><br/>
系统的解决办法是出现一个新的网卡，<br/>
从IP的角度来看，他还是交给了一个MAC实体。<br/>
就像第一幅抓包出来的图一样，<br/>
这里一样看得到一对MAC地址。<br/><br/>
该网卡是ppp虚拟出来的网卡，<br/>
它很清楚应该怎样封装ppp和pppoe，<br/>
然后填上自己的mac和服务器的mac。<br/>
所以都准备好后，<br/>
这时才交给物理网卡处理。<br/><br/>
这样就很好地解释为什么两个网卡上抓出来的不一样了。<br/><br/>
这种并列的结构应该是一种巧妙的实现，<br/>
相比堆叠的结构，不会导致上层的改变。<br/><br/><br/><a href="http://www.box.net/shared/tqcmas9rag" target="_blank">cap文件下载</a>。<br/>
两种网卡下抓的包，<br/>
附带PPPoE连接和断开过程。<br/><br/><br/><br/><br/><br/>
