---
layout: post
title: "用XML文件保存配置信息的一个类(C#)"
date: 2010-05-08  17:08
comments: true
categories: tech
tags: [".net","c#","sql"]
_baiduhi_id: fa12104ccb587bf5d62afc2a.html
_baiduhi_category: .net&c#&sql
---

<p>(hplonline)2010.5.8</p>
<p>貌似没有找到直接支持读写INI文件的类，<br/>
虽然网上也有不少草根版的类可用，<br/>
很多人还是建议使用XML来做。</p>
<p>XML一套的东西实在是太多，<br/>
各种名字搞得眼花缭乱，<br/>
只选了两个常用方法，<br/>
封装一个类，对程序配置信息进行Get和Set即可。</p>
<p>SelectSingleNode返回的是XmlNode的对象，<br/>
该对象还可以继续SelectSingleNode，用于索引其下的子对象。<br/>
它的InnerText即代表的里面的文本内容，<br/>
是个string型的，直接进行读写即可。</p>
<p>另外考虑到客户（程序员）可能直接Set一个不存在的节点，<br/>
于是当SelectSingleNode返回null的时候，<br/>
使用CreateElement创建一个该名字的节点即可。</p>
<p>最后，第一次使用程序的时候，<br/>
可能该配置文件都不存在。<br/>
于是先尝试打开文件，<br/>
发生IO错误的时候新建一个，<br/>
填上基本的XML信息，添加一个Root节点。<br/>
（这节代码copy的网上某处，搞忘地方了）</p>
<p><font color="#0000ff">一。CConfig类的代码：</font></p>
<p>     class CConfig<br/>
     {<br/>
         private string _FileName;<br/>
         private XmlDocument _xmlDocument;</p>
<p>         public string FileName<br/>
         {<br/>
             get<br/>
             {<br/>
                 return _FileName;<br/>
             }<br/>
             set<br/>
             {<br/>
                 _FileName = value;<br/>
             }<br/>
         }</p>
<p>         // return :<br/>
         // true : the file exist and we open it <br/>
         // false : the file doesn't exist and we create it <br/>
         public bool Open()<br/>
         {<br/>
             try<br/>
             {<br/>
                 _xmlDocument.Load(_FileName);<br/>
             }<br/>
             catch (System.IO.FileNotFoundException)<br/>
             {<br/>
                 //if file is not found, create a new xml file<br/>
                 XmlTextWriter xmlWriter = new XmlTextWriter(_FileName, System.Text.Encoding.UTF8);<br/>
                 xmlWriter.Formatting = Formatting.Indented;<br/>
                 xmlWriter.WriteProcessingInstruction("xml", "version='1.0' encoding='UTF-8'");<br/>
                 xmlWriter.WriteStartElement("Root");<br/>
                 //If WriteProcessingInstruction is used as above,<br/>
                 //Do not use WriteEndElement() here<br/>
                 //xmlWriter.WriteEndElement();<br/>
                 //it will cause the &lt;Root&gt;&lt;/Root&gt; to be &lt;Root /&gt;<br/>
                 xmlWriter.Close();<br/>
                 _xmlDocument.Load(_FileName);<br/>
                 return false;<br/>
             }<br/>
             return true;<br/>
         }</p>
<p>         public CConfig(string strFileName)<br/>
         {<br/>
             FileName = strFileName;<br/>
             _xmlDocument = new XmlDocument();<br/>
             this.Open();<br/>
         }</p>
<p>         ~CConfig()<br/>
         {<br/>
             Save();<br/>
         }</p>
<p>         public void Save()<br/>
         {<br/>
             _xmlDocument.Save(_FileName);<br/>
         }</p>
<p>         public string Get(string strName)<br/>
         {<br/>
             XmlNode node = _xmlDocument.SelectSingleNode("Root").SelectSingleNode(strName);<br/>
             if (node == null)<br/>
             {<br/>
                 return "nonexist";<br/>
             }<br/>
             else<br/>
             {<br/>
                 return node.InnerText;<br/>
             }<br/>
         }</p>
<p>         public void Set(string strName, string strValue)<br/>
         {<br/>
             XmlNode root = _xmlDocument.SelectSingleNode("Root");<br/>
             XmlNode node = root.SelectSingleNode(strName);</p>
<p>             if (node != null)<br/>
             {<br/>
                 node.InnerText = strValue;<br/>
             }<br/>
             else<br/>
             {<br/>
                 XmlElement elem = _xmlDocument.CreateElement(strName);<br/>
                 elem.InnerText = strValue;<br/>
                 root.AppendChild(elem);<br/>
             }<br/>
         }</p>
<p><font color="#0000ff">二。使用示例：</font></p>
<p>创建访问XML配置文件的对象<br/>
CConfig Config = new CConfig("config.xml");</p>
<p>读取一个配置值<br/>
_IPAddress = Config.Get("IPAddress");</p>
<p>设置一个配置值并保存<br/>
Config.Set("IPAddress", _IPAddress);<br/>
Config.Save();</p>
<p><font color="#0000ff">三。评价：</font></p>
<p>跟XML相关的5个名字空间，<br/>
提供了一整套解决方案，<br/>
不过东西太多，初学比较繁琐。</p>
<p>用XML来管理配置信息比较方便。<br/>
比如设置一个配置信息：<br/>
Config.Set("IPAddress", _IPAddress);<br/>
不用关心在文件中各个条目的先后顺序。<br/>
读取也是如此。<br/>
另外XML的纯文本特性便于用户直接修改配置文件。</p>
<p>配置信息多的时候，还可以多分几层，<br/>
比如&lt;SystemConfig&gt;下放跟系统有关的配置，<br/>
&lt;UserConfig&gt;下放跟用户偏好有关的配置。</p>
